# Overview

This repo illustrates how to create a golden image pipeline using Packer and Terraform, specifically, how to build an virtual machine image using Packer, store the metadata for it in a HCP Packer registry and then finally
create a virtual machine using an image referenced from the registry:

<img style="float: left; margin: 0px 15px 15px 0px;" src="https://github.com/chrisadkin/packer-golden-img-pipeline/blob/main/png_images/golden_image_workflow.png?raw=true">

The Packer element of the workflow largely mirrors the contents of [this HashiCorp tutorial](https://developer.hashicorp.com/packer/tutorials/hcp-get-started/hcp-push-image-metadata), the rest of the repo provides additional context and links the Packer element to Terraform.

The pipeline comprises of the following stages:

1. Packer HCL file creation for golden images, these are essentially text files which specify how to create images in Packer's dialect of HashiCorp Configuration Language (HCL).

2. Building an image via Packer and pushing its metadata to HCP Packer - what is essentially an image registry.

3. Virtual machine creation via Terraform using image details obtained from HCP Packer.

# Prerequisites
## Generic Prerequisites

- [Packer 1.7.10](https://developer.hashicorp.com/packer/downloads) installed locally
- [Terraform 1.6.2](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli) installed locally
- A [HashiCorp Cloud Platform](https://www.hashicorp.com/cloud) account

## AWS Prerequisites
- An AWS account with credentials set as local environment variables. These credentials must have permissions to create, modify, and delete EC2 instances. Refer to the documentation to find the full list IAM permissions required to run the amazon-ebs builder.

## Azure Prerequisites
- An Azure account
- [Azure CLI](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli#install) installed locally

# Instructions and Narrative
## Building An AWS AMI Image

For building an AMI image and pushing it to a HCP Packer registry follow [this HashiCorp tutorial](https://developer.hashicorp.com/packer/tutorials/hcp-get-started/hcp-push-image-metadata)

## Building An Azure Image

1. Create HCP Packer registry

Go to the HashiCorp Cloud Platform portal. After logging in, you will find Packer under "Services" in the left navigation menu.

You must enable the HCP Packer registry before Packer can publish build metadata to it. Click the Create a registry button after clicking on the Packer link under "Services" in the left navigation.
This only needs to be done once.
<Image>

2. Create HCP service principal and set the HCP_CLIENT_ID and HCP_SECRET environment variables

In HCP Packer, go to Access control (IAM) in the left navigation menu, then select the Service principals tab.

Create a service principal named packer with the Contributor role.

Once you create the service principal, click the service principal name to view its details. From the detail page, click + Generate key to create a client ID and secret.

Copy and save the client ID and secret; you will not be able to retrieve the secret later. You will use these credentials in the next step.
<Image>

Once you generate the keys for the service principal, set the client ID and secret as environment variables so that Packer can authenticate with HCP.

In your terminal, set an environment variable for the client ID.

4. Clone this repo:
```
git clone https://github.com/chrisadkin/packer-golden-img-pipeline
```

5. Create an Azure service principal:   
```
az ad sp create-for-rbac --role Contributor --scopes /subscriptions/<subscription_id> --query "{ client_id: appId, client_secret: password, tenant_id: tenant }
```
   Note the client id, client secret and tenant id that result from this.

7. Change directory to packer-golden-img-pipeline

8. Review the Packer template
```   
source "azure-arm" "autogenerated_1" {
  azure_tags = {
    dept = "Engineering"
    task = "Image deployment"
  }
  client_id                         = var.client_id
  client_secret                     = var.client_secret
  image_offer                       = "0001-com-ubuntu-server-jammy"
  image_publisher                   = "canonical"
  image_sku                         = "22_04-lts"
  location                          = "East US"
  managed_image_name                = var.image_name
  managed_image_resource_group_name = var.resource_name
  os_type                           = "Linux"
  subscription_id                   = var.subscription_id
  tenant_id                         = var.tenant_id
  vm_size                           = "Standard_DS2_v2"
}

build {
  sources = ["source.azure-arm.autogenerated_1"]

  provisioner "shell" {
    execute_command = "chmod +x {{ .Path }}; {{ .Vars }} sudo -E sh '{{ .Path }}'"
    inline          = ["apt-get update", "apt-get upgrade -y", "apt-get -y install nginx", "/usr/sbin/waagent -force -deprovision+user && export HISTSIZE=0 && sync"]
    inline_shebang  = "/bin/sh -x"
  }
}
```
